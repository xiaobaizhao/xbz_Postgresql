# 关于PG数据备份策略说明文档
- 备份技术概述
- 主从复制(流复制)
- 备份方案与适用场景

## 备份技术概述
数据库的备份有多种分类方式。
按照备份后的文件类型，可以分为物理备份（文件系统级别的备份）和逻辑备份（备份后的文件是sql文件或特定格式的导出文件）；
按照备份过程中是否停止数据库服务，可分为冷备份（备份过程中停止数据库服务）和热备份（备份过程中数据库服务开启并可供用户访问）；
按照备份是否是完整的数据库，可分为全量备份(备份是完整的数据库)和增量备份（备份是上一次全量备份后数据库改变的内容）

Postgresql的常见备份方式有如下三种：  

**1、文件系统级别的冷备份**  
>这种备份方式需要关闭数据库，然后拷贝数据文件的完整目录，恢复数据时，只需要将数据木复制到原来的位置。(该方式实际工作中甚少使用)

**2、SQL转储**
>- 这种方式可以在数据库正在使用的时候进行完整一致的备份，并不阻塞其他用户对数据库的访问。它会产生一个脚本文件，里边包含备份开始时，已创建的各种数据库对象的SQL语句和每个表中的数据。
>- 通过pg_dump和pg_dumpall工具实现备份。其中，  
pg_dump只能备份数据库集群中的某个数据库的数据(也可以针对具体表进行备份)，它不会导出角色和表空间相关的信息，因为这些信息是整个数据库集群共用的，不属于某个单独的数据库。  
pg_dumpall对集簇中的每个数据库调用pg_dump来完成备份工作，还会转储对所有数据表公用的全局对象(pg_dump不保存这些对象)。目前这包括数据库用户和组、表空间及适合所有数据库的访问权限等属性。  

**3、连续归档**
>这种方式的策略是把一个文件系统级别的全量备份和WAL(预写式日志)级别的增量备份结合起来。当需要恢复时，我们先恢复文件系统级别的备份，然后重放备份的WAL文件，把系统恢复到之前的某个状态。这种备份有显著的优点：

>- 1. 不需要一个完美的一致的文件系统备份作为开始点。备份中的任何内部不一致性将通过日志重放来修正。
>- 2. 可以结合一个无穷长的WAL文件序列用于重放，可以通过简单地归档WAL文件来达到连续备份。
>- 3. 不需要重放WAL项一直到最后。可以在任何点停止重放，并使数据库恢复到当时的一致状态。
>- 4. 可以连续地将一系列WAL文件输送给另一台已经载入了相同基础备份文件的机器，得到一个实时的热备份系统。

## 主从复制 (流复制)
 > PostgreSQL数据库支持多种复制解决方案，以构建高可用性，可伸缩，容错的应用程序，其中之一是预写日志（WAL）传送。该解决方案允许使用基于文件的日志传送或流复制。
 
> 流复制其原理为：备库不断的从主库同步相应的数据，并在备库apply每个WAL record，这里的流复制每次传输单位是WAL日志的record。默认情况下，流复制是异步的，其中在将事务提交到主服务器后将数据写入备用服务器。这意味着在主服务器中提交事务与更改在备用服务器中变得可见之间存在很小的延迟。

> 使用流复制时，备用（复制从属）数据库服务器被配置为连接到主服务器/主服务器，主服务器/主服务器在生成WAL记录时将其流传输到备用服务器，而无需等待WAL文件被填充。

**流复制的类型**  
流复制可以分为如下两种类型：
- 异步流复制：  
存在如果主服务器崩溃，则可能无法复制任何未提交的事务导致未提交事务相关数据丢失的缺点。
- 同步流复制:  
存在性能压力问题的同时，如果备库宕机，主库也会被挂起(异步则无此影响)。

## 备份方案与实施策略
### 方案一：SQL转储方式  
**具体实施步骤:**
>- 1.制作pg_dump任务脚本，按高频次(如：2天间隔)对指定数据库或数据表进行备份。并设置备份失效时间(如：1个月的数据有效期)
>- 2.制作pg_dumpall任务脚本，按中频次(如：1周间隔)对数据库做全量备份，并设置备份失效时间(如：1个月的数据有效期)

**灾备还原方式:**
>- 搭建PG环境后，使用pg_dumpall、pg_dump工具将备份数据导入即可(注意PG版本差异性)

**策略优缺点**
>- 优点：实现简单，灵活性较强，可实现对单个数据库或数据表的备份
>- 缺点：仅能还原已经备份的数据，未备份数据无法找回

### 方案二： 连续归档
**具体实施步骤：**
>- 1.挂载外置存储设备，充当归档目录
>- 2.修改postgresql.conf文件相关配置参数，开启归档模式
>- 3.停止PG服务
>- 4.导出全量数据备份(制作基础备份目录)
>- 5.重启PG服务，并验证归档模式是否开启成功

**灾备还原方式：**
>- 1. 搭建PG环境后，清理数据目录，将导出的全量数据备份(基础备份目录)替换进去
>- 2. 修改 postgresql.auto.conf 文件，选择要还原到的时间节点
>- 3. 重启PG应用
>- 4. 验证数据是否还原成功

**策略优缺点**
>- 优点：采用WAL日志归档方式，能有效保证数据的正确性，并且能根据时间节点进行还原到指定时间的数据状态
>- 缺点：实现相对复杂，如果没有来得及归档的数据，还原时无法找回。

### 方案三： 主从复制
**具体实施步骤：**
>- 1.搭建PG备份服务
>- 2.配置主从相关配置参数
>- 3.重启PG服务，并验证主从同步是否生效

**灾备还原方式：**
> 主服务发生灾难时，通过执行切换函数，实现将备数据库切换为主数据库。

**策略优缺点**
>- 优点： 能在最短时间内对数据库进行还原动作，并且能实现数据库的读写分离
>- 缺点： 默认为异步流复制，则流复制可能存在延迟(1s以内)，导致延迟数据丢失的风险。且不能根据时间节点对数据进行还原

### 方案四： 主从复制 + 连续归档
**具体实施步骤**
>在实现主从复制的基础上，开启连续归档功能。

**灾备还原方式**
> 主服务发生灾难时，通过主从切换实现对数据的还原。当需要查看指定时间节点的数据状态时，可利用归档日志对数据进行还原

**策略优缺点**
>- 优点： 通过双策略，在能最大程度的保证数据的安全备份的同时，也支持按时间节点还原数据
>- 缺点： 实现操作相对复杂，双备份策略对服务器资源具有一定要求


**参考链接**  
Postgresql的三种备份方式  
https://blog.csdn.net/international24/article/details/82689136  
PostgreSQL流复制详解  
https://blog.csdn.net/weixin_39540651/article/details/106122610
PostgreSQL12-主从复制  
https://www.jianshu.com/p/aa53a10cad29



<font color=gray>文档内容仅用于学习使用。如有侵权，请及时联系QQ群：647934871</font>